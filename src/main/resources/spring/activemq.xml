<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:amq="http://activemq.apache.org/schema/core" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
  http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core-5.5.0.xsd">
    <!-- brokerURL=failover:(tcp://activemq1:61616,tcp://activemq2:61616)?randomize=false -->
    <amq:connectionFactory id="mqFactory" brokerURL="tcp://activemq.com:61616">
    	<property name="redeliveryPolicy" ref="activeMQRedeliveryPolicy"></property>
    </amq:connectionFactory>

    <amq:queue id="testQueue1" physicalName="testQueue1" />
    <amq:topic id="testTopic1" physicalName="testTopic1" />
	<amq:redeliveryPolicy id="activeMQRedeliveryPolicy" redeliveryDelay="100" maximumRedeliveries="2" />
	
    <bean id="myMessageConverter" class="com.activemq.util.MyMessageConverter" />
    <bean id="myListener" class="com.activemq.listeners.MyMessageListener">
        <property name="convertor" ref="myMessageConverter"></property>
    </bean>

    <bean id="myTemplate" class="org.springframework.jms.core.JmsTemplate">
        <property name="connectionFactory">
            <bean
                class="org.springframework.jms.connection.SingleConnectionFactory">
                <property name="targetConnectionFactory" ref="mqFactory" />
            </bean>
        </property>
        <property name="messageConverter" ref="myMessageConverter" />
        <!-- 不用设置也能失败重试 -->
<!--         <property name="sessionAcknowledgeMode" value="2" /> -->
    </bean>

    <bean id="testQueueProducer" class="com.activemq.util.MyMessageProducer">
        <property name="template" ref="myTemplate" />
        <property name="destination" ref="testQueue1" />
    </bean>
    <bean id="testTopicProducer" class="com.activemq.util.MyMessageProducer">
        <property name="template" ref="myTemplate" />
        <property name="destination" ref="testTopic1" />
    </bean>

    <bean
        class="org.springframework.jms.listener.DefaultMessageListenerContainer">
        <property name="connectionFactory" ref="mqFactory" />
        <property name="destination" ref="testQueue1" />
        <property name="messageListener" ref="myListener" />
        <property name="sessionTransacted" value="true"></property>
    </bean>

    <bean
        class="org.springframework.jms.listener.DefaultMessageListenerContainer">
        <property name="connectionFactory" ref="mqFactory" />
        <property name="destination" ref="testTopic1" />
        <property name="messageListener" ref="myListener" />
    </bean>
</beans>